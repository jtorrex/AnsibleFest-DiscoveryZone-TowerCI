---

- name: issue failure when private token not defined
  fail:
    msg: |
      gitlab_private_token is not defined.  Please login in to the web interface
      as root and obtain a personal access token at https://gitlab/profile/personal_access_tokens.
      The token values should be added to the vars/main.yml file
  when: gitlab_private_token is not defined

- block:
  - yum:
      name: epel-release
      state: installed
    become: yes
      
  - name: ensure git is insalled
    yum:
      name: git, python-pip
      state: present
    become: yes
    
  - name: ensure gitlab python installed
    pip:
      name: python-gitlab
      state: present
    become: yes
  when: not skip_pkgs | default(false) | bool

- name: gitlab automation
  block:

  - include_tasks: add-key.yml

  - name: create gitlab group(s)
    gitlab_group:
      name: AutomationContent
      state: present
      visibility: public
    tags: project

  - name: create gitlab users
    gitlab_user:
      username: ansiblefest
      password: password
      email: ansiblefest@gitlab.fest.com
      name: ansiblefest
      #ssh key doesn't work
      # sshkey_file: /home/vagrant/.ssh/id_rsa.pub
      # sshkey_name: default
      isadmin: no

  - include_tasks: 
      file: import_project.yml
      apply:
        tags: project
    vars:
      gitlab_import_project: "{{ item }}"
    tags: project
    loop:
    - tower-onboarding
    - tower-starter-pack

  become: false
  module_defaults:
    uri:
      validate_certs: no
      return_content: yes
      body_format: json
      headers:
        Private-Token:  "{{gitlab_private_token}}"
    gitlab_group:
      #api_url:  "https://localhost/"
      server_url:  "https://localhost/"
      validate_certs: False
      api_token: "{{ gitlab_private_token }}"
    gitlab_user:
      #api_url:  "https://localhost/"
      server_url:  "https://localhost/"
      validate_certs: False
      api_token: "{{ gitlab_private_token }}"
    gitlab_project:
      #api_url:  "https://localhost/"
      server_url:  "https://localhost/"
      validate_certs: False
      api_token: "{{ gitlab_private_token }}"
      #force_basic_auth: yes
